<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ù„Ø³Ø© Ø­Ø¶ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø© ğŸ“</title>
  <style>
    body { font-family: "Tajawal", sans-serif; background: #f4f6f8; text-align: center; padding: 40px; }
    input, button { padding: 10px; margin: 5px; width: 250px; border: 1px solid #ccc; border-radius: 5px; font-size: 16px; }
    button { cursor: pointer; border: none; }
    .btn-blue { background: #007bff; color: white; }
    .btn-green { background: #28a745; color: white; }
    #qrLink a { color: #007bff; text-decoration: none; }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
</head>
<body>
  <h2>Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ù„Ø³Ø© Ø­Ø¶ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø© ğŸ“</h2>

  <input id="subject" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©">
  <input id="sessionNumber" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¬Ù„Ø³Ø©">
  <input id="teacher" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…">
  <input id="latitude" placeholder="Ø®Ø· Ø§Ù„Ø¹Ø±Ø¶">
  <input id="longitude" placeholder="Ø®Ø· Ø§Ù„Ø·ÙˆÙ„">
  <input id="radius" placeholder="Ù†ØµÙ Ù‚Ø·Ø± Ø§Ù„Ø³Ù…Ø§Ø­ (Ù…ØªØ±)">
  <input id="duration" placeholder="Ù…Ø¯Ø© Ø§Ù„Ø¬Ù„Ø³Ø© (Ø¯Ù‚Ø§Ø¦Ù‚)">

  <br>
  <button class="btn-blue" onclick="createSession()">âœ… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ÙƒÙˆØ¯</button>
  <p id="qrLink" style="color:red"></p>

  <button class="btn-green" onclick="window.location.href='attendance.html'">ğŸ“‹ Ø¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±</button>

  <canvas id="qr" style="margin-top:20px;"></canvas>

  <script>
    // ØªÙˆÙ„ÙŠØ¯ Ù…Ø¹Ø±Ù‘Ù ÙØ±ÙŠØ¯ Ù„Ù„Ø¬Ù„Ø³Ø©
    function generateSessionId() {
      return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    async function createSession() {
      const sessionId = generateSessionId();
      const payload = {
        sessionId: sessionId,
        subject: document.getElementById("subject").value,
        sessionNumber: document.getElementById("sessionNumber").value,
        teacher: document.getElementById("teacher").value,
        latitude: parseFloat(document.getElementById("latitude").value),
        longitude: parseFloat(document.getElementById("longitude").value),
        radius: parseFloat(document.getElementById("radius").value),
        duration: parseFloat(document.getElementById("duration").value)
      };

      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
      if (!payload.subject || !payload.teacher || !payload.sessionNumber) {
        document.getElementById("qrLink").innerHTML = "âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©!";
        return;
      }

      try {
        const res = await fetch("/create-session", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const data = await res.json();
        if (data.status === "success") {
          const baseUrl = window.location.origin;
          const link = `${baseUrl}/student.html?sessionId=${sessionId}`;
          document.getElementById("qrLink").innerHTML = `ğŸ“ <a href="${link}" target="_blank">${link}</a>`;
          new QRious({ element: document.getElementById("qr"), value: link, size: 200 });
        } else {
          document.getElementById("qrLink").innerHTML = `âš ï¸ ${data.message}`;
        }
      } catch (err) {
        document.getElementById("qrLink").innerHTML = "âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø±Ø§Ø¨Ø·!";
        console.error(err);
      }
    }
  </script>
</body>
</html>
